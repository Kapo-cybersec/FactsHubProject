<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FactsHub{% endblock %}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        header { background: rgba(255, 255, 255, 0.95); padding: 1rem 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 100; }
        header nav { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; }
        .nav-links { display: flex; gap: 2rem; align-items: center; }
        .nav-links a { text-decoration: none; color: #667eea; font-weight: 500; }
        button { padding: 0.7rem 1.5rem; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .container { max-width: 1200px; margin: 3rem auto; padding: 0 2rem; }
        .alert { padding: 1rem; border-radius: 10px; margin-bottom: 1rem; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #333; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; }
    </style>
    {% block head_extra %}{% endblock %}
</head>
<body>
    <header>
        <nav>
            <a href="/" class="logo">üìö FactsHub</a>
            <div class="nav-links">
                <a href="/">Strona G≈Ç√≥wna</a>
                <a href="/archive">Archiwum</a>
                {% if current_user %}
                    <a href="/submit-fact">Dodaj Fakt</a>
                    <a href="/profile">Profil</a>
                    {% if session.get('rola') in ['admin', 'moderator'] %}
                        <a href="/admin">Panel Moderacji</a>
                    {% endif %}
                    <a href="/logout">Wyloguj</a>
                {% else %}
                    <button class="btn-secondary" onclick="showAuthModal('login')">Zaloguj</button>
                    <button class="btn-primary" onclick="showAuthModal('register')">Rejestruj</button>
                {% endif %}
            </div>
        </nav>
    </header>

    <main class="container">
        <div id="alerts"></div>
        {% block content %}{% endblock %}
    </main>

    {% if not current_user %}
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span style="float: right; font-size: 2rem; cursor: pointer; color: #999;" onclick="closeAuthModal()">&times;</span>
            <div id="loginForm" style="display: none;">
                <h2>Zaloguj siƒô</h2>
                <form onsubmit="login(event)">
                    <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required></div>
                    <div class="form-group"><label>Has≈Ço</label><input type="password" id="loginPassword" required></div>
                    <button type="submit" class="btn-primary" style="width: 100%;">Zaloguj</button>
                </form>
            </div>
            <div id="registerForm" style="display: none;">
                <h2>Rejestracja</h2>
                <form onsubmit="register(event)">
                    <div class="form-group"><label>Nazwa u≈ºytkownika</label><input type="text" id="regUsername" required></div>
                    <div class="form-group"><label>Email</label><input type="email" id="regEmail" required></div>
                    <div class="form-group"><label>Has≈Ço</label><input type="password" id="regPassword" required></div>
                    <button type="submit" class="btn-primary" style="width: 100%;">Zarejestruj</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="factModal" class="modal">
        <div class="modal-content">
            <span style="float: right; font-size: 2rem; cursor: pointer; color: #999;" onclick="closeFactModal()">&times;</span>
            <div id="factDetails"></div>
        </div>
    </div>

    <script>
        function showAuthModal(type) {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('loginForm').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = type === 'register' ? 'block' : 'none';
        }
        function closeAuthModal() { document.getElementById('authModal').classList.remove('active'); }
        function login(e) {
            e.preventDefault();
            fetch('/login', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value})})
            .then(r => r.json()).then(d => {if(d.success){showAlert(d.success, 'success'); setTimeout(() => location.reload(), 1000);}else{showAlert(d.error, 'error');}});
        }
        function register(e) {
            e.preventDefault();
            fetch('/register', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: document.getElementById('regUsername').value, email: document.getElementById('regEmail').value, password: document.getElementById('regPassword').value})})
            .then(r => r.json()).then(d => {if(d.success){showAlert(d.success, 'success'); showAuthModal('login');}else{showAlert(d.error, 'error');}});
        }
        function showAlert(m, t) {
            const d = document.createElement('div');
            d.className = 'alert alert-' + t;
            d.textContent = m;
            document.getElementById('alerts').appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }
        function viewFactDetails(id) {
            fetch('/api/fact/' + id).then(r => r.json()).then(d => {
                const f = d.fact; const c = d.comments || [];
                let h = `<h2>${f.tytul}</h2><span class="fact-category">${f.kategoria || 'Og√≥lne'}</span><p style="margin-top: 1rem; color: #999;">Autor: ${f.autor || 'Anonimowy'}</p>`;
                h += `<p style="margin: 1.5rem 0; font-size: 1.1rem;">${f.tresc}</p>`;
                if(f.zrodlo) h += `<p><strong>≈πr√≥d≈Ço:</strong> <a href="${f.zrodlo}" target="_blank">Link</a></p>`;
                h += `<div class="comments-section"><h3>Komentarze (${c.length})</h3><form onsubmit="addComment(event, ${f.id})"><div class="form-group"><textarea id="commentText" placeholder="Napisz komentarz..." required style="min-height: 80px;"></textarea></div><button type="submit" class="btn-primary">Dodaj Komentarz</button></form><div style="margin-top: 2rem;">`;
                c.forEach(cm => {
                    h += `<div class="comment"><div style="font-weight: 600; color: #667eea;">${cm.pseudonim_goscia || cm.username || 'Go≈õƒá'}</div><div style="color: #333; line-height: 1.6; margin: 0.5rem 0;">${cm.tresc}</div><div style="font-size: 0.85rem; color: #999;">${new Date(cm.data_dodania).toLocaleDateString('pl-PL')}</div><button style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; background: #e0e0e0;" onclick="likeComment(${cm.id})">üëç ${cm.likes || 0}</button></div>`;
                });
                h += '</div></div>';
                document.getElementById('factDetails').innerHTML = h;
                document.getElementById('factModal').classList.add('active');
            });
        }
        function closeFactModal() { document.getElementById('factModal').classList.remove('active'); }
        function addComment(e, fid) {
            e.preventDefault();
            fetch('/api/comment', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({fact_id: fid, tresc: document.getElementById('commentText').value})})
            .then(r => r.json()).then(d => {showAlert(d.success || d.error, d.success ? 'success' : 'error'); if(d.success){setTimeout(() => viewFactDetails(fid), 500);}});
        }
        function likeComment(cid) {
            fetch('/api/reaction', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({comment_id: cid})})
            .then(r => r.json()).then(d => showAlert(d.success || d.error, d.success ? 'success' : 'error'));
        }
        document.querySelectorAll('.modal').forEach(m => {m.addEventListener('click', (e) => {if(e.target === m) m.classList.remove('active');});});
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>